name: Build & Create PR

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

env:
  # Variables
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}
  NODE_ENV: ${{ vars.NODE_ENV }} 
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECS_CLUSTER: ${{ vars.ECS_CLUSTER }}
  ECS_SERVICE: ${{ vars.ECS_SERVICE }}
  TASK_FAMILY: ${{ vars.TASK_FAMILY }}
  INFLUXDB_USER: ${{ vars.INFLUXDB_USER }}
  INFLUXDB_URL: ${{ vars.INFLUXDB_URL }}
  INFLUXDB_DB: ${{ vars.INFLUXDB_DB }}
  GHCR: ${{ vars.GHCR }}
  GHCR_USER: ${{ vars.GH_USER }}
  GH_PAT: ${{ secrets.GH_PASS }}
  

  # Secrets
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  INFLUXDB_PASS: ${{ secrets.INFLUXDB_PASS }}

jobs:
  build-and-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_branch: ${{ steps.create_pr.outputs.pr_branch }}
    steps:
      # 1️⃣ Checkout code
      - uses: actions/checkout@v4

      # 2️⃣ Configure Git identity (CRUCIAL: before commit)
      - name: Configure Git for commits
        run: |
          git config --global user.name "dylanrmrz"
          git config --global user.email "dylan.ramirez@lansa.com"

      # 3️⃣ Bump package.json version
      - name: Bump version
        id: bump_version
        run: |
          if [ -f package.json ]; then
            CURRENT_VERSION=$(jq -r ".version" package.json)
            IFS="." read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

            # Simple patch bump
            PATCH=$((PATCH+1))
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            echo "New version: $NEW_VERSION"

            # Update package.json
            jq --arg v "$NEW_VERSION" '.version=$v' package.json > tmp.json
            mv tmp.json package.json

            echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          else
            echo "package.json not found"
            exit 1
          fi

      # 4️⃣ Commit & push version bump
      - name: Commit & push version bump
        id: commit_push
        run: |
          BRANCH="bump-v${NEW_VERSION}-${{ github.run_id }}"
          git switch -c $BRANCH
          git add package.json
          git commit -m "ci: version bump to $NEW_VERSION"
          git push origin $BRANCH
          echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT

      # 5️⃣ Create PR
      - name: Create PR
        id: create_pr
        env:
          GH_TOKEN: ${{ env.GH_PAT }}
        run: |
          BRANCH="${{ steps.commit_push.outputs.BRANCH }}"
          echo "Creating PR for branch: $BRANCH"
          gh pr create \
            --title "ci: release v${NEW_VERSION}" \
            --body "Automated version bump generated by workflow" \
            --base main \
            --head "$BRANCH" \
            --reviewer dv-lansa,Lansa-jerson
          echo "pr_branch=$BRANCH" >> $GITHUB_OUTPUT

      # 6️⃣ Optional: Output full image tag for downstream jobs
      - name: Set full image tag
        id: image_tag
        run: |
          FULL_IMAGE="${IMAGE_NAME}:${NEW_VERSION}"
          echo "FULL_IMAGE=$FULL_IMAGE" >> $GITHUB_ENV
          echo "full_image=$FULL_IMAGE" >> $GITHUB_OUTPUT

