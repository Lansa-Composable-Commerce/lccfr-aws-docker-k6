name: Deploy After Merge

on:
  push:
    branches:
      - main   # ðŸ”¥ Runs only when PR is merged into main

permissions:
  contents: read
  deployments: write

env:
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}
  NODE_ENV: ${{ vars.NODE_ENV }}
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECS_CLUSTER: ${{ vars.ECS_CLUSTER }}
  ECS_SERVICE: ${{ vars.ECS_SERVICE }}
  TASK_FAMILY: ${{ vars.TASK_FAMILY }}
  GHCR: ${{ vars.GHCR }}
  GHCR_USER: ${{ vars.GH_USER }}

  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  GH_PAT: ${{ secrets.GH_PAT }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    # ðŸ”¥ This makes GitHub require environment approval
    environment:
      name: production

    steps:
      - uses: actions/checkout@v4

      - name: Extract version from commit message
        id: extract_version
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          VERSION=$(echo "$COMMIT_MSG" | grep -oP "v\d+\.\d+\.\d+" || true)

          if [ -z "$VERSION" ]; then
            echo "âŒ Could not extract version from commit message"
            exit 1
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Extracted version: $VERSION"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GHCR }}
          username: ${{ env.GHCR_USER }}
          passw
