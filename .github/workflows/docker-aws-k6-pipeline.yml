name: Load Test

on:
  push:
    branches:
      - main

jobs:
  load_test:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Create results directory
      - name: Prepare results directory
        run: |
          mkdir -p results
          chmod 777 results

      # Run k6 using the official Docker image (same as GitLab)
      - name: Run K6 Load Test
        uses: docker://grafana/k6:latest
        env:
          INFLUXDB_USER: ${{ secrets.INFLUXDB_USER }}
          INFLUXDB_PASS: ${{ secrets.INFLUXDB_PASS }}
          INFLUX_URL: ${{ secrets.INFLUX_URL }}
          INFLUXDB_DB: ${{ secrets.INFLUXDB_DB }}
          TEST_CYCLE_TAG: ${{ github.run_id }}     # equivalent to $CI_PIPELINE_ID
        with:
          entrypoint: /bin/sh
          args: -c "
            echo 'ðŸš€ Running K6 load test and sending metrics to InfluxDB...' &&
            echo 'Using TEST_CYCLE_TAG=$TEST_CYCLE_TAG' &&
            k6 run \
              --tag test_cycle=$TEST_CYCLE_TAG \
              -e TEST_CYCLE_TAG=$TEST_CYCLE_TAG \
              --out influxdb=http://$INFLUXDB_USER:$INFLUXDB_PASS@$INFLUX_URL/$INFLUXDB_DB \
              --summary-export results/summary.json \
              tests/performance/test.js"

      # Upload results (equivalent to GitLab artifacts)
      - name: Upload k6 results artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-results
          path: results/
          retention-days: 7

      # Allow job to fail without failing the workflow (same as GitLab allow_failure)
      - name: Mark job as successful even if k6 failed
        if: failure()
        run: echo "K6 test failed but allow_failure=true equivalent is enabled."
